<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Loan Amortization Calculator by Aquari Finance. Generate EMI schedules, Interest-only and Balloon payments with Excel export.">
  <meta name="robots" content="index, follow">
  <meta property="og:title" content="Loan Amortization Tool – Aquari Finance">
  <meta property="og:description" content="Dynamic amortization calculator for Indian and International formats. Download Excel schedules instantly.">
  <title>Loan Amortization Calculator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xirr@1.0.5/dist/xirr.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f1f5f9;
      --card-bg: #ffffff;
      --text-color: #0f172a;
      --border-color: #cbd5e1;
      --accent-color: #3b82f6;
      --hover-color: #2563eb;
      --secondary-bg: #e0f2fe;
      --row-even: #f8fafc;
      --row-hover: #e2e8f0;
    }

    .dark-mode {
      --bg-color: #1e293b;
      --card-bg: #334155;
      --text-color: #f8fafc;
      --border-color: #475569;
      --accent-color: #60a5fa;
      --hover-color: #3b82f6;
      --secondary-bg: #1e40af;
      --row-even: #475569;
      --row-hover: #64748b;
    }

    body {
      font-family: 'Inter', sans-serif;
      padding: 30px;
      background: var(--bg-color);
      margin: 0;
      color: var(--text-color);
      transition: all 0.3s ease;
    }

    .main-container {
      width: 80%;
      margin: 0 auto;
    }

    h2 { text-align: center; margin-bottom: 30px; }
    .container { 
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }
    .form-section {
      background-color: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
      grid-column: 1;
    }
    .chart-section {
      background-color: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
      grid-column: 2;
      grid-row: 1;
      display: none;
    }
    .table-section {
      background-color: var(--card-bg);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
      grid-column: 1 / span 2;
      overflow-x: auto;
    }
    .stats-container { display: flex; justify-content: space-between; margin-top: 20px; }
    .stat-box { background: var(--row-even); padding: 15px; border-radius: 8px; flex: 1; margin: 0 10px; text-align: center; }
    .stat-value { font-size: 24px; font-weight: 700; color: var(--accent-color); }
    .stat-label { font-size: 14px; color: var(--text-color); opacity: 0.8; }
    label { display: block; margin-top: 15px; font-weight: 600; }
    input, select, button {
      width: 100%; padding: 10px; margin-top: 5px; margin-bottom: 15px;
      font-size: 15px; border-radius: 8px; border: 1px solid var(--border-color);
      box-sizing: border-box; background: var(--card-bg); color: var(--text-color);
    }
    button { background-color: var(--accent-color); color: white; font-weight: 600; cursor: pointer; transition: background-color 0.3s ease; }
    button:hover { background-color: var(--hover-color); }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
    th, td { border: 1px solid var(--border-color); padding: 10px; text-align: right; }
    th { background-color: var(--secondary-bg); font-weight: 700; position: sticky; top: 0; }
    tr:nth-child(even) { background-color: var(--row-even); }
    tr:hover { background-color: var(--row-hover); }
    .chart-container { position: relative; height: 400px; width: 100%; }
    .hidden { display: none; }
    .error-message {
      color: #ef4444;
      font-size: 14px;
      margin-top: -10px;
      margin-bottom: 10px;
      display: none;
    }
    .tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
    
    /* From Uiverse.io by vinodjangid07 */
    /* To hide the checkbox */
    #checkboxInput {
      display: none;
    }

    .toggleSwitch {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      width: 50px;
      height: 30px;
      background-color: rgb(82, 82, 82);
      border-radius: 20px;
      cursor: pointer;
      transition-duration: .2s;
    }

    .toggleSwitch::after {
      content: "";
      position: absolute;
      height: 10px;
      width: 10px;
      left: 5px;
      background-color: transparent;
      border-radius: 50%;
      transition-duration: .2s;
      box-shadow: 5px 2px 7px rgba(8, 8, 8, 0.26);
      border: 5px solid white;
    }

    #checkboxInput:checked+.toggleSwitch::after {
      transform: translateX(100%);
      transition-duration: .2s;
      background-color: white;
    }
    /* Switch background change */
    #checkboxInput:checked+.toggleSwitch {
      background-color: rgb(148, 118, 255);
      transition-duration: .2s;
    }
    
    .switches-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      align-items: center;
    }
    
    .switch-label {
      margin-right: 10px;
      font-weight: 600;
    }
  </style>
  <link rel="icon" type="image/png" href="https://aquarifinance.com/wp-content/uploads/2025/04/Aquari_Finance_1.2-155x155.png" />
</head>

<body>
  <div class="main-container">
    <a href="https://aquarifinance.com/" style="display:inline-block; margin-bottom:20px;">
      <img src="https://aquarifinance.com/wp-content/uploads/2025/04/Aquari_Finance_1.2-155x155.png" alt="Aquari Finance" style="height:150px;">
    </a>
    
    <div class="switches-container">
      <div>
        <span class="switch-label">Dark Mode</span>
        <input type="checkbox" id="checkboxInput" onchange="toggleTheme()">
        <label for="checkboxInput" class="toggleSwitch"></label>
      </div>
      
      <div>
        <span class="switch-label">Comma System:</span>
        <select id="commaSystem" onchange="formatLoanAmount()">
          <option value="indian" selected>Indian</option>
          <option value="international">International</option>
        </select>
      </div>
    </div>
        
    <h2>Loan Amortization Calculator</h2>

    <div class="container">
      <div class="form-section">
        <label>Loan Amount</label>
        <input type="text" id="loanAmount" oninput="formatLoanAmount()">
        <div id="loanAmountError" class="error-message">Please enter a valid loan amount</div>

        <label>Interest Rate (%)</label>
        <input type="number" step="0.01" id="interestRate">
        <div id="interestRateError" class="error-message">Please enter a valid interest rate</div>

        <label class="tooltip">Tenure (Years,Months)
          <span class="tooltiptext">Enter years and months separated by comma (e.g., "5,3" for 5 years and 3 months)</span>
        </label>
        <input type="text" id="tenure" placeholder="e.g., 5 or 5,3">
        <div id="tenureError" class="error-message">Please enter valid tenure (e.g., 5 or 5,3)</div>

        <label>Start Date</label>
        <input type="date" id="startDate">
        <div id="startDateError" class="error-message">Please select a start date</div>

        <label>Repayment Frequency</label>
        <select id="repaymentFreq">
          <option value="Monthly">Monthly</option>
          <option value="Quarterly">Quarterly</option>
          <option value="Halfyearly">Halfyearly</option>
          <option value="Annually">Annually</option>
        </select>

        <label>Moratorium (Months)</label>
        <input type="number" id="moratorium" min="0">
        <div id="moratoriumError" class="error-message">Moratorium cannot be negative</div>

        <label>Processing Fee (%)</label>
        <input type="number" step="0.01" id="processingFee" min="0">

        <label>Professional Fee (%)</label>
        <input type="number" step="0.01" id="professionalFee" min="0">

        <label>Other Costs</label>
        <input type="number" id="otherCosts" min="0">

        <label>Repayment Type</label>
        <select id="repaymentType">
          <option value="EMI">EMI</option>
          <option value="InterestOnly">Interest Only</option>
          <option value="Balloon">Balloon Payment</option>
        </select>

        <button onclick="validateAndGenerate()">Generate Schedule</button>
        <button onclick="downloadExcel()">Download Excel</button>
      </div>

      <div class="chart-section" id="chartSection">
        <h3 style="text-align: center; margin-bottom: 20px;">Loan Summary</h3>
        <div class="chart-container">
          <canvas id="cashflowChart"></canvas>
        </div>
        <div class="stats-container">
          <div class="stat-box">
            <div class="stat-value" id="totalPrincipal">₹0</div>
            <div class="stat-label">Total Principal</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="totalInterest">₹0</div>
            <div class="stat-label">Total Interest</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="totalFees">₹0</div>
            <div class="stat-label">Total Fees</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="effectiveRate">0%</div>
            <div class="stat-label">Effective Interest Rate (XIRR)</div>
          </div>
        </div>
      </div>

      <div class="table-section">
        <table id="scheduleTable"></table>
      </div>
    </div>
  </div>

<script>
// Global variables
let scheduleData = [];
let cashflowChart = null;
let totalPrincipal = 0;
let totalInterest = 0;
let totalFees = 0;
let xirrData = [];
let isDarkMode = false;

// Month names for date formatting
const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

// Theme toggle function
function toggleTheme() {
  isDarkMode = !isDarkMode;
  document.body.classList.toggle('dark-mode', isDarkMode);
  
  // Update chart colors if it exists
  if (cashflowChart) {
    updateChartColors();
  }
}

function updateChartColors() {
  if (!cashflowChart) return;
  
  cashflowChart.options.plugins.legend.labels.color = getComputedStyle(document.body).getPropertyValue('--text-color');
  cashflowChart.update();
}

// Input validation
function validateInputs() {
  let isValid = true;
  const loanAmount = document.getElementById('loanAmount').value.replace(/,/g, '');
  const interestRate = document.getElementById('interestRate').value;
  const tenure = document.getElementById('tenure').value;
  const startDate = document.getElementById('startDate').value;
  const moratorium = document.getElementById('moratorium').value;

  // Reset error messages
  document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');

  if (!loanAmount || isNaN(loanAmount) || parseFloat(loanAmount) <= 0) {
    document.getElementById('loanAmountError').style.display = 'block';
    isValid = false;
  }

  if (!interestRate || isNaN(interestRate) || parseFloat(interestRate) <= 0) {
    document.getElementById('interestRateError').style.display = 'block';
    isValid = false;
  }

  // Validate tenure (can be "5" or "5,3")
  const tenureParts = tenure.split(',');
  if (!tenure || tenureParts.length > 2 || 
      (tenureParts.length === 1 && (isNaN(tenureParts[0]) || parseInt(tenureParts[0]) <= 0)) ||
      (tenureParts.length === 2 && (isNaN(tenureParts[0]) || parseInt(tenureParts[0]) < 0 || 
                                    isNaN(tenureParts[1]) || parseInt(tenureParts[1]) < 0 || parseInt(tenureParts[1]) >= 12))) {
    document.getElementById('tenureError').style.display = 'block';
    isValid = false;
  }

  if (!startDate) {
    document.getElementById('startDateError').style.display = 'block';
    isValid = false;
  }

  if (moratorium && parseInt(moratorium) < 0) {
    document.getElementById('moratoriumError').style.display = 'block';
    isValid = false;
  }

  return isValid;
}

function parseTenure(tenureStr) {
  const parts = tenureStr.split(',');
  let years = parseInt(parts[0]) || 0;
  let months = parts.length > 1 ? parseInt(parts[1]) || 0 : 0;
  
  // Convert months to fractional years for calculation
  const totalYears = years + (months / 12);
  const totalMonths = (years * 12) + months;
  
  return { years: totalYears, months: totalMonths };
}

function validateAndGenerate() {
  if (validateInputs()) {
    generateSchedule();
  } else {
    // Scroll to the first error
    const firstError = document.querySelector('.error-message[style="display: block;"]');
    if (firstError) {
      firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }
}

function formatIndianNumber(x) {
  x = x.toString().replace(/,/g, '');
  if (x.indexOf('.') !== -1) {
    const parts = x.split('.');
    return formatIndianNumber(parts[0]) + '.' + parts[1];
  }
  let lastThree = x.substring(x.length - 3);
  let otherNumbers = x.substring(0, x.length - 3);
  if (otherNumbers !== '') lastThree = ',' + lastThree;
  return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree;
}

function formatInternationalNumber(x) {
  x = x.toString().replace(/,/g, '');
  if (x.indexOf('.') !== -1) {
    const parts = x.split('.');
    return formatInternationalNumber(parts[0]) + '.' + parts[1];
  }
  return x.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

function formatNumber(value, system) {
  value = parseFloat(value).toFixed(2);
  return system === 'indian' ? formatIndianNumber(value) : formatInternationalNumber(value);
}

function formatLoanAmount() {
  let loanInput = document.getElementById('loanAmount');
  let commaSystem = document.getElementById('commaSystem').value;
  let value = loanInput.value.replace(/,/g, '');
  if (isNaN(value)) return;
  if (commaSystem === 'indian') {
    loanInput.value = formatIndianNumber(value);
  } else {
    loanInput.value = formatInternationalNumber(value);
  }
}

function getFrequency(freq) {
  switch (freq) {
    case "Monthly": return 12;
    case "Quarterly": return 4;
    case "Halfyearly": return 2;
    case "Annually": return 1;
    default: return 12;
  }
}

function formatDate(date) {
  let d = new Date(date);
  return ("0" + d.getDate()).slice(-2) + "-" + monthNames[d.getMonth()] + "-" + d.getFullYear();
}

function formatCurrency(value, system) {
  value = parseFloat(value);
  if (system === 'indian') {
    if (value >= 10000000) return '₹' + (value/10000000).toFixed(2) + ' Cr';
    if (value >= 100000) return '₹' + (value/100000).toFixed(2) + ' L';
    return '₹' + formatIndianNumber(value.toFixed(2));
  } else {
    if (value >= 1000000000) return '$' + (value/1000000000).toFixed(2) + ' B';
    if (value >= 1000000) return '$' + (value/1000000).toFixed(2) + ' M';
    if (value >= 1000) return '$' + (value/1000).toFixed(2) + ' K';
    return '$' + formatInternationalNumber(value.toFixed(2));
  }
}

function calculateXIRR(cashflows) {
  // Validate input
  if (!cashflows || cashflows.length < 2) {
    console.warn("XIRR requires at least two cash flows");
    return 0;
  }

  // Extract values and dates from cashflows
  const values = [];
  const dates = [];
  
  cashflows.forEach(item => {
    values.push(item.amount);
    dates.push(new Date(item.date));
  });

  // Check for both positive and negative values
  let hasPositive = false;
  let hasNegative = false;
  
  values.forEach(amount => {
    if (amount > 0) hasPositive = true;
    if (amount < 0) hasNegative = true;
  });

  if (!hasPositive || !hasNegative) {
    console.warn("XIRR requires both positive and negative cash flows");
    return 0;
  }

  // Set reasonable bounds for IRR
  const MIN_RATE = -0.9999999;  // -99.99999%
  const MAX_RATE = 100;         // 10,000%
  const MAX_ITERATIONS = 100;
  const PRECISION = 1e-10;

  // Helper functions
  const calculateResult = (rate) => {
    let result = 0;
    const r = 1 + rate;
    const startDate = dates[0];
    
    for (let i = 0; i < values.length; i++) {
      const days = (dates[i] - startDate) / (1000 * 60 * 60 * 24);
      result += values[i] / Math.pow(r, days / 365);
    }
    return result;
  };

  // Newton-Raphson implementation
  let rate = 0.1;  // Initial guess
  let iteration = 0;
  let contLoop = true;
  let result;

  while (contLoop && iteration < MAX_ITERATIONS) {
    result = calculateResult(rate);
    
    // Numerical approximation of derivative
    const rateUp = rate * 1.0001;
    const resultUp = calculateResult(rateUp);
    const derivative = (resultUp - result) / (rateUp - rate);
    
    // Avoid division by zero
    if (Math.abs(derivative) < PRECISION) {
      break;
    }

    const newRate = rate - result / derivative;
    
    // Check for convergence
    if (Math.abs(newRate - rate) < PRECISION) {
      contLoop = false;
      rate = newRate;
    } else {
      rate = Math.max(MIN_RATE, Math.min(MAX_RATE, newRate));
    }
    
    iteration++;
  }

  // Validate result
  if (isNaN(rate)) {
    console.warn("XIRR calculation failed - invalid result");
    return 0;
  }

  // Convert to percentage
  const annualizedRate = rate * 100;
  
  // Return 0 for nonsensical results
  if (annualizedRate < -100 || annualizedRate > 100000) {
    console.warn("XIRR result out of reasonable bounds:", annualizedRate);
    return 0;
  }

  return annualizedRate;
}

function generateSchedule() {
  const loanAmount = parseFloat(document.getElementById('loanAmount').value.replace(/,/g, ''));
  const rate = parseFloat(document.getElementById('interestRate').value) / 100;
  const tenureStr = document.getElementById('tenure').value;
  const { years, months: totalMonths } = parseTenure(tenureStr);
  const startDate = new Date(document.getElementById('startDate').value);
  const freq = document.getElementById('repaymentFreq').value;
  const repaymentType = document.getElementById('repaymentType').value;
  const moratorium = parseInt(document.getElementById('moratorium').value) || 0;
  const procFee = (parseFloat(document.getElementById('processingFee').value.replace(/,/g, '')) || 0) / 100 * loanAmount;
  const professionalFee = (parseFloat(document.getElementById('professionalFee').value.replace(/,/g, '')) || 0) / 100 * loanAmount;
  const otherCosts = parseFloat(document.getElementById('otherCosts').value.replace(/,/g, '')) || 0;
  const extraCosts = procFee + professionalFee + otherCosts;

  const paymentsPerYear = getFrequency(freq);
  const totalPayments = Math.ceil(totalMonths / (12 / paymentsPerYear));
  const periodRate = rate / paymentsPerYear;

  // Reset totals
  totalPrincipal = 0;
  totalInterest = 0;
  totalFees = extraCosts;
  
  // Initialize xirrData with initial cashflow (loan received net of fees)
  xirrData = [
  // Loan disbursement (positive cash flow)
  {
    date: new Date(startDate),
    amount: loanAmount,
    description: "Loan Disbursement"
  },
  
  // Fees (negative cash flows)
  {
    date: new Date(startDate),
    amount: -extraCosts,
    description: "Fees Deducted"
  }
];

  let emi = 0;
  if (repaymentType === "EMI") {
    emi = loanAmount * periodRate / (1 - Math.pow(1 + periodRate, -totalPayments));
  } else if (repaymentType === "InterestOnly") {
    emi = loanAmount * periodRate;
  } else if (repaymentType === "Balloon") {
    emi = (loanAmount * 0.02);
  }

  scheduleData = [];
  let balance = loanAmount;
  let cumulative = 0;
  let paymentDate = new Date(startDate);
  
  // Add initial disbursement row (Payment No 0)
  scheduleData.push([
    0,
    formatDate(paymentDate),
    formatNumber(0, document.getElementById('commaSystem').value),
    formatNumber(0, document.getElementById('commaSystem').value),
    formatNumber(extraCosts, document.getElementById('commaSystem').value),
    formatNumber(extraCosts, document.getElementById('commaSystem').value),
    formatNumber(0, document.getElementById('commaSystem').value),
    formatNumber(0, document.getElementById('commaSystem').value),
    formatNumber(loanAmount, document.getElementById('commaSystem').value),
    formatNumber(extraCosts, document.getElementById('commaSystem').value),
    (loanAmount - extraCosts).toFixed(2)
  ]);

  // Calculate moratorium periods based on frequency
  const moratoriumPeriods = Math.ceil(moratorium / (12 / paymentsPerYear));
  const adjustedTotalPayments = totalPayments + moratoriumPeriods;

  for (let i = 1; i <= adjustedTotalPayments; i++) {
    // Advance payment date based on frequency
    if (freq === "Monthly") paymentDate.setMonth(paymentDate.getMonth() + 1);
    else if (freq === "Quarterly") paymentDate.setMonth(paymentDate.getMonth() + 3);
    else if (freq === "Halfyearly") paymentDate.setMonth(paymentDate.getMonth() + 6);
    else if (freq === "Annually") paymentDate.setFullYear(paymentDate.getFullYear() + 1);

    let interest = balance * periodRate;
    let principal = 0;
    let payment = emi;

    if (i <= moratoriumPeriods) {
      payment = 0;
      if (repaymentType === "InterestOnly") {
        payment = interest;
      } else {
        interest = 0;
      }
      principal = 0;
    } else {
      if (repaymentType === "EMI") {
        principal = payment - interest;
      } else if (repaymentType === "InterestOnly") {
        principal = (i === adjustedTotalPayments) ? balance : 0;
        payment = (i === adjustedTotalPayments) ? (balance + interest) : interest;
      } else if (repaymentType === "Balloon") {
        principal = (i === adjustedTotalPayments) ? balance : 0;
        payment = (i === adjustedTotalPayments) ? (balance + interest) : emi;
      }
    }

    let endingBalance = balance - principal;
    let extraPayment = 0; // Only in first actual payment
    let totalPayment = payment + extraPayment;
    cumulative += totalPayment;

    // Update totals
    totalPrincipal += parseFloat(principal);
    totalInterest += parseFloat(interest);

    // Add to XIRR data (payments are negative cashflows)
    if (totalPayment > 0 || i === adjustedTotalPayments) {
      xirrData.push({
        date: new Date(paymentDate),
        amount: -totalPayment
      });
    }

    // Format values with commas
    const commaSystem = document.getElementById('commaSystem').value;
    const formattedBalance = formatNumber(balance, commaSystem);
    const formattedPayment = formatNumber(payment, commaSystem);
    const formattedExtraPayment = formatNumber(extraPayment, commaSystem);
    const formattedTotalPayment = formatNumber(totalPayment, commaSystem);
    const formattedPrincipal = formatNumber(principal, commaSystem);
    const formattedInterest = formatNumber(interest, commaSystem);
    const formattedEndingBalance = formatNumber(endingBalance, commaSystem);
    const formattedCumulative = formatNumber(cumulative, commaSystem);

    scheduleData.push([
      i,
      formatDate(paymentDate),
      formattedBalance,
      formattedPayment,
      formattedExtraPayment,
      formattedTotalPayment,
      formattedPrincipal,
      formattedInterest,
      formattedEndingBalance,
      formattedCumulative,
      -totalPayment.toFixed(2)
    ]);

    balance = endingBalance;
  }

  showTable(scheduleData);
  updateChartAndStats();
}

function showTable(data) {
  const table = document.getElementById('scheduleTable');
  table.innerHTML = '';

  const headers = ['PMT No', 'Payment Date', 'Beginning Balance', 'Scheduled Payment', 'Extra Payment', 
                  'Total Payment', 'Principal', 'Interest', 'Ending Balance', 'Cumulative Balance'];
  let thead = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '<th class="hidden">Net Cashflow</th></tr></thead>';
  let tbody = '<tbody>';
  data.forEach(row => {
    tbody += '<tr>' + 
      row.slice(0, -1).map(cell => `<td>${cell}</td>`).join('') + 
      `<td class="hidden">${row[row.length-1]}</td>` +
      '</tr>';
  });
  tbody += '</tbody>';
  table.innerHTML = thead + tbody;
}

function updateChartAndStats() {
  document.getElementById('chartSection').style.display = 'block';
  
  const commaSystem = document.getElementById('commaSystem').value;
  document.getElementById('totalPrincipal').textContent = formatCurrency(totalPrincipal, commaSystem);
  document.getElementById('totalInterest').textContent = formatCurrency(totalInterest, commaSystem);
  document.getElementById('totalFees').textContent = formatCurrency(totalFees, commaSystem);
  
  const effectiveRate = calculateXIRR(xirrData);
  document.getElementById('effectiveRate').textContent = effectiveRate.toFixed(2) + '%';
  
  const ctx = document.getElementById('cashflowChart').getContext('2d');
  
  if (cashflowChart) {
    cashflowChart.destroy();
  }
  
  cashflowChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['Principal', 'Interest', 'Fees'],
      datasets: [{
        data: [totalPrincipal, totalInterest, totalFees],
        backgroundColor: [
          '#3b82f6',
          '#10b981',
          '#f59e0b'
        ],
        borderWidth: 1,
        hoverOffset: 15
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.raw || 0;
              const formattedValue = formatCurrency(value, document.getElementById('commaSystem').value);
              return `${label}: ${formattedValue} (${((value / (totalPrincipal + totalInterest + totalFees)) * 100).toFixed(1)}%)`;
            }
          }
        },
        legend: {
          position: 'right',
          labels: {
            color: getComputedStyle(document.body).getPropertyValue('--text-color')
          }
        },
        title: {
          display: true,
          text: 'Cashflow Breakup',
          font: {
            size: 16
          },
          color: getComputedStyle(document.body).getPropertyValue('--text-color')
        }
      }
    }
  });
}

function downloadExcel() {
  const wb = XLSX.utils.book_new();
  
  const exportData = [
    ['Loan Amount', document.getElementById('loanAmount').value],
    ['Interest Rate', document.getElementById('interestRate').value],
    ['Tenure', document.getElementById('tenure').value],
    ['Start Date', document.getElementById('startDate').value],
    ['Repayment Frequency', document.getElementById('repaymentFreq').value],
    ['Moratorium', document.getElementById('moratorium').value],
    ['Processing Fee (%)', document.getElementById('processingFee').value],
    ['Professional Fee (%)', document.getElementById('professionalFee').value],
    ['Other Costs', document.getElementById('otherCosts').value],
    ['Repayment Type', document.getElementById('repaymentType').value],
    ['Total Principal', totalPrincipal],
    ['Total Interest', totalInterest],
    ['Total Fees', totalFees],
    ['Effective Interest Rate (XIRR)', calculateXIRR().toFixed(2) + '%'],
    [],
    ['PMT No', 'Payment Date', 'Beginning Balance', 'Scheduled Payment', 'Extra Payment', 
     'Total Payment', 'Principal', 'Interest', 'Ending Balance', 'Cumulative Balance', 'Net Cashflow'],
    ...scheduleData.map(row => [...row.slice(0, -1), parseFloat(row[row.length-1])])
  ];

  const ws = XLSX.utils.aoa_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb, ws, "Amortization");
  XLSX.writeFile(wb, "Loan_Amortization_Schedule.xlsx");
}
</script>
</body>
</html>